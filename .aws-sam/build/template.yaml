AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  Environment:
    Type: String
    Default: dev
  CognitoClientID:
    Type: String
    Default: ''
Globals:
  Function:
    Timeout: 10
    Runtime: nodejs18.x
    Handler: index.lambdaHandler
    Architectures:
    - x86_64
    Layers:
    - Ref: Core
Resources:
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: QuizApp-${Environment}
      UsernameAttributes:
      - email
      - phone_number
      Schema:
      - Name: email
        Required: true
        Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireNumbers: true
          RequireSymbols: true
          RequireUppercase: true
  UserPoolTokenClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId:
        Ref: UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
      - USER_PASSWORD_AUTH
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName:
        Ref: Environment
      Name: QuizApp
      Cors:
        AllowMethods: '''*'''
        AllowHeaders: '''*'''
        AllowOrigin: '''*'''
  Core:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: nodejs
      ContentUri: ../../layers
  LoginUser:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: LoginUser
      CodeUri: LoginUser
      Policies:
      - AmazonCognitoPowerUser
      - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          CognitoClientID:
            Ref: CognitoClientID
      Events:
        APICall:
          Type: Api
          Properties:
            Path: /login
            Method: post
            RestApiId:
              Ref: ApiGateway
    Metadata:
      SamResourceId: LoginUser
